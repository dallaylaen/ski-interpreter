#!/bin/sh

set -ex

AUTOFILES="docs/build docs/man types"

modified() {
    LIST=$(git status --porcelain -- "$@" | grep '^ *[AM?]' | awk '{print $2}')
    echo $LIST
}

./aux/browserify.sh
npx -p typescript tsc index.js --declaration --allowJs --emitDeclarationOnly --outDir types

CHANGED=$(modified $AUTOFILES)

if [ ! -z "$CHANGED" ]; then
    HOLD=$(modified lib test);
    if [ -z "$HOLD" ]; then
        # TODO some checking
        git commit $CHANGED -m "[auto] Update autogenerated $CHANGED" --no-verify
    else
        echo >&2 "[githook] Would commit ($CHANGED) if not for uncommitted ($HOLD)"
    fi
fi


