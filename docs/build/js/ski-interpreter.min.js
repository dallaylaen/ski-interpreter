(()=>{var z=(n,e)=>()=>(e||n((e={exports:{}}).exports,e),e.exports);var Q=z((_e,M)=>{var I=class{constructor(...e){let t="$|(\\s+)|"+e.map(s=>"(?:"+s+")").sort((s,r)=>r.length-s.length).join("|");this.rex=new RegExp(t,"gys")}split(e){this.rex.lastIndex=0;let t=[...e.matchAll(this.rex)],r=t.pop()?.index??0;if(r!==e.length)throw new Error("Unknown tokens at pos "+r+"/"+e.length+" starting with "+e.substring(r));return t.filter(a=>a[1]===void 0).map(a=>a[0])}},ce=new I("[-=+]","[A-Z]","\\b[a-z_][a-z_0-9]*\\b");function ue(n,e){if(!e)return n;let t=new Set([...n]),s=0,r=[a=>{t=new Set([a]),s=1},a=>{t.add(a)},a=>{t.delete(a)}];for(let a of ce.split(e))a==="="?s=0:a==="+"?s=1:a==="-"?s=2:r[s](a);return t}M.exports={Tokenizer:I,restrict:ue}});var H=z((ve,G)=>{"use strict";var N={max:1e3,maxArgs:32},f=class n{constructor(){if(new.target===n)throw new Error("Attempt to instantiate abstract class Expr")}apply(...e){return e.length>0?new d(this,...e):this}expand(){return this}freeOnly(){return!this.any(e=>!(e instanceof w||e instanceof d))}replace(e,t={}){let s=[];if(e.length===0)return this;for(let r of e){let a=Array.isArray(r)?r:[r,r];if(a[0]=a[0].guess(t).expr,!a[0])throw new Error("Failed to canonize term "+r);if(a.length!==2)throw new Error("Expected a pair of terms to replace, got "+r);s.push(a)}return this._replace(s,t)??this}traverse(e){return e(this)}any(e){return e(this)}_replace(e,t){let s=this.guess(t).expr;for(let[r,a]of e)if(s.equals(r))return a;return null}weight(){return 1}guess(e={}){let t=e.max??N.max,s=e.maxArgs??N.maxArgs;return this._guess({max:t,maxArgs:s,index:0})}_guess(e,t=[],s=0){if(t.length>e.maxArgs||s>e.max)return{normal:!1,steps:s};if(this.freeOnly())return{normal:!0,steps:s,...B(t,this)};let r=this.run({max:(e.max-s)/3});if(s+=r.steps,!r.final)return{normal:!1,steps:s};if(r.steps!==0)return r.expr._guess(e,t,s);if(this._firstVar())return{normal:!1,steps:s};let a=J(t.length+e.index);return this.apply(a)._guess(e,[...t,a],s)}_aslist(){return[this]}_firstVar(){return!1}*lambdify(e={}){let t=j(this,e);yield*V(t,e)}*rewriteSKI(e={}){let t=0,s=this;for(;;){let r={max:e.max??1,steps:0},a=s._rski(r),l=r.steps===0;if(yield{expr:s,steps:t,final:l},l)break;s=a,t+=r.steps}}_rski(e){return this}subst(e,t){return this===e?t:null}invoke(e){return null}step(){return{expr:this,steps:0,changed:!1}}run(e={},...t){e instanceof n&&(t.unshift(e),e={});let s=t?this.apply(...t):this,r=e.steps??0,a=Math.max(e.max??N.max,1)+r,l=!1;for(;r<a;){let i=s.step();if(!i.changed){l=!0;break}r+=i.steps,s=i.expr}if(e.throw&&!l)throw new Error("Failed to compute expression in "+a+" steps");return{final:l,steps:r,expr:s}}*walk(e={}){let t=e.max??1/0,s=0,r=this,a=!1;for(;s<t;){let l=r.step();if(l.changed||(a=!0),yield{expr:r,steps:s,final:a},a)break;s+=l.steps,r=l.expr}}equals(e){return!this.diff(e)}diff(e,t=!1){return this===e?null:e instanceof x?e.impl.diff(this,!t):t?"["+e+" != "+this+"]":"["+this+" != "+e+"]"}expect(e,t=""){if(t=t?t+": ":"",!(e instanceof n))throw new Error(t+"attempt to expect a combinator to equal something else: "+e);let s=this.diff(e);if(!s)return;let r=new Error(t+s);throw r.expected=e+"",r.actual=this+"",r}toString(){return this.format()}_braced(e){return!1}_unspaced(e){return this._braced(!0)}format(e={}){let t=e.html?{brackets:["(",")"],space:" ",var:["<var>","</var>"],lambda:["","-&gt;",""],around:["",""],redex:["",""]}:{brackets:["(",")"],space:" ",var:["",""],lambda:["","->",""],around:["",""],redex:["",""]};return this._format({terse:e.terse??!0,brackets:e.brackets??t.brackets,space:e.space??t.space,var:e.var??t.var,lambda:e.lambda??t.lambda,around:e.around??t.around,redex:e.redex??t.redex,inventory:e.inventory,html:e.html??!1},0)}_format(e,t){throw new Error("No _format() method defined in class "+this.constructor.name)}_declare(e,t,s){}},d=class n extends f{constructor(e,...t){if(t.length===0)throw new Error("Attempt to create an application with no arguments (likely interpreter bug)");super(),this.arg=t.pop(),this.fun=t.length?new n(e,...t):e,this.final=!1,this.arity=this.fun.arity>0?this.fun.arity-1:0}weight(){return this.fun.weight()+this.arg.weight()}_guess(e,t=[],s=0){if(t.length>e.maxArgs||s>e.max)return{normal:!1,steps:s};let r=super._guess(e,t,s);if(r.normal)return r;s=r.steps;let[a,...l]=this._aslist();if(!(a instanceof w))return{normal:!1,steps:s};let i=!1,h=!1,c=[];for(let o of l){let u=o._guess({...e,maxArgs:e.maxArgs-t.length,max:e.max-s,index:t.length+e.index});if(s+=u.steps,!u.normal)return{normal:!1,steps:s};c.push(u.expr),i=i||u.discard,h=h||u.duplicate}return{normal:!0,steps:s,...B(t,new n(a,...c),{discard:i,duplicate:h})}}_firstVar(){return this.fun._firstVar()}expand(){return this.fun.expand().apply(this.arg.expand())}_replace(e,t){let s=super._replace(e,t);if(s)return s;let[r,a]=this.split();return(r._replace(e,t)??r).apply(a._replace(e,t)??a)}traverse(e){let t=e(this);if(t instanceof f)return t;let s=this.fun.traverse(e),r=this.arg.traverse(e);return!s&&!r?null:(s??this.fun).apply(r??this.arg)}any(e){return e(this)||this.fun.any(e)||this.arg.any(e)}subst(e,t){let s=this.fun.subst(e,t),r=this.arg.subst(e,t);return s||r?(s??this.fun).apply(r??this.arg):null}step(){if(!this.final){let e=this.fun.invoke(this.arg);if(e instanceof f)return{expr:e,steps:1,changed:!0};typeof e=="function"&&(this.invoke=e);let t=this.fun.step();if(t.changed)return{expr:t.expr.apply(this.arg),steps:t.steps,changed:!0};let s=this.arg.step();if(s.changed)return{expr:this.fun.apply(s.expr),steps:s.steps,changed:!0};this.final=!0}return{expr:this,steps:0,changed:!1}}invoke(e){let t=this.fun.invoke(this.arg);return t instanceof f?t.apply(e):typeof t=="function"?(this.invoke=t,t(e)):(this.invoke=s=>null,null)}split(){return[this.fun,this.arg]}_aslist(){return[...this.fun._aslist(),this.arg]}_rski(e){return e.steps>=e.max?this:this.fun._rski(e).apply(this.arg._rski(e))}diff(e,t=!1){if(!(e instanceof n))return super.diff(e,t);let s=this.fun.diff(e.fun,t);if(s)return s+"(...)";let r=this.arg.diff(e.arg,t);return r?this.fun+"("+r+")":null}_braced(e){return!e}_format(e,t){let s=this.fun._format(e,t+1),r=this.arg._format(e,0),a=t?["",""]:e.around;return e.terse&&!this.arg._braced(!1)?a[0]+s+(this.fun._unspaced(this.arg)?"":e.space)+r+a[1]:a[0]+s+e.brackets[0]+r+e.brackets[1]+a[1]}_declare(e,t,s){this.fun._declare(e,t,s),this.arg._declare(e,t,s)}_unspaced(e){return this.arg._braced(!1)?!0:this.arg._unspaced(e)}},_=class n extends f{constructor(e){if(super(),typeof e!="string"||e.length===0)throw new Error("Attempt to create a named term with improper name");this.name=e}_unspaced(e){return!!(e instanceof n&&(this.name.match(/^[A-Z+]$/)&&e.name.match(/^[a-z+]/i)||this.name.match(/^[a-z+]/i)&&e.name.match(/^[A-Z+]$/)))}_format(e,t){let s=e.html?this.fancyName??this.name:this.name;return this.arity>0&&this.arity<=t?e.redex[0]+s+e.redex[1]:s}},oe=0,w=class n extends _{constructor(e,t){super(e),this.id=++oe,this.scope=t===void 0?this:t}weight(){return 0}_firstVar(){return!0}diff(e,t=!1){if(!(e instanceof n))return super.diff(e,t);if(this.name===e.name&&this.scope===e.scope)return null;let s=this.name+"["+this.id+"]",r=e.name+"["+e.id+"]";return t?"["+r+" != "+s+"]":"["+s+" != "+r+"]"}subst(e,t){return e instanceof n&&e.name===this.name&&e.scope===this.scope?t:null}_format(e,t){let s=e.html?this.fancyName??this.name:this.name;return e.var[0]+s+e.var[1]}},S=class extends _{constructor(e,t,s={}){super(e),this.invoke=t;let r=s.canonize??!0?this.guess():{normal:!1};this.arity=s.arity||r.arity||1,this.note=s.note??r.expr?.format({terse:!0,html:!0,lambda:[""," &mapsto; ",""]})}_rski(e){if(this===m.I||this===m.K||this===m.S||e.steps>=e.max)return this;let t=this.guess().expr;return t?(e.steps++,t._rski(e)):this}},m={};function k(n,e,t){m[n]=new S(n,e,t)}var b=class n extends f{constructor(e,t){if(Array.isArray(e)){if(e.length===0)throw new Error("empty argument list in lambda constructor");let[r,...a]=e,l=new Set([r.name]);for(;a.length>0;){let i=a.pop();if(l.has(i.name))throw new Error("Duplicate free var name "+i+" in lambda expression");l.add(i.name),t=new n(i,t)}e=r}super();let s=new w(e.name,this);this.arg=s,this.impl=t.subst(e,s)??t,this.arity=1}weight(){return this.impl.weight()+1}_guess(e,t=[],s=0){if(t.length>e.maxArgs)return{normal:!1,steps:s};let r=J(t.length+e.index);return this.invoke(r)._guess(e,[...t,r],s+1)}invoke(e){return this.impl.subst(this.arg,e)??this.impl}traverse(e){let t=e(this);if(t instanceof f)return t;let s=this.impl.traverse(e);return s?new n(this.arg,s):null}any(e){return e(this)||this.impl.any(e)}subst(e,t){if(e===this.arg)return null;let s=this.impl.subst(e,t);return s?new n(this.arg,s):null}expand(){return new n(this.arg,this.impl.expand())}_rski(e){let t=this.impl._rski(e);if(e.steps>=e.max)return new n(this.arg,t);if(e.steps++,t===this.arg)return m.I;if(!t.any(s=>s===this.arg))return m.K.apply(t);if(t instanceof d){let[s,r]=t.split();return r===this.arg&&!s.any(a=>a===this.arg)?s._rski(e):m.S.apply(new n(this.arg,s)._rski(e),new n(this.arg,r)._rski(e))}throw new Error("Don't know how to convert to SKI"+this)}_replace(e,t){let s=super._replace(e,t);return s||new n(this.arg,this.impl._replace(e,t)??this.impl)}diff(e,t=!1){if(!(e instanceof n))return super.diff(e,t);let s=new w("t"),r=this.invoke(s).diff(e.invoke(s),t);return r?"(t->"+r+")":null}_format(e,t){return(t>0?e.brackets[0]:"")+e.lambda[0]+this.arg._format(e,0)+e.lambda[1]+this.impl._format(e,0)+e.lambda[2]+(t>0?e.brackets[1]:"")}_declare(e,t,s){this.impl._declare(e,t,s)}_braced(e){return!0}},F=class n extends S{constructor(e){let t=Number.parseInt(e);if(!(t>=0))throw new Error("Church number must be a non-negative integer");let s=""+t,r=a=>l=>{let i=l;for(let h=t;h-- >0;)i=a.apply(i);return i};super(s,r,{arity:2,canonize:!1,note:s}),this.n=t,this.arity=2}diff(e,t=!1){return e instanceof n?this.n===e.n?null:t?"["+e.n+" != "+this.n+"]":"["+this.n+" != "+e.n+"]":super.diff(e,t)}_unspaced(e){return!1}};function W(n,e){return t=>e<=1?n.apply(t):W(n.apply(t),e-1)}var x=class extends _{constructor(e,t,s={}){super(e),this.impl=t,s.note&&(this.note=s.note);let r=s.canonize?t.guess({max:s.max,maxArgs:s.maxArgs}):{normal:!1};this.arity=r.proper&&r.arity||0,this.proper=r.proper??!1,this.terminal=s.terminal??this.proper,this.canonical=r.expr,this.invoke=W(t,this.arity)}weight(){return this.terminal?1:this.impl.weight()}expand(){return this.impl.expand()}traverse(e){return e(this)??this.impl.traverse(e)}any(e){return e(this)||this.impl.any(e)}subst(e,t){return this===e?t:this.impl.subst(e,t)}_guess(e,t=[],s=0){return this.impl._guess(e,t,s)}step(){return this.arity>0?{expr:this,steps:0,changed:!1}:{expr:this.impl,steps:0,changed:!0}}_firstVar(){return this.impl._firstVar()}diff(e,t=!1){return this===e?null:e.diff(this.impl,!t)}_rski(e){return this.impl._rski(e)}_braced(e){return this.outdated?this.impl._braced(e):!1}_format(e,t){return(e.inventory?e.inventory[this.name]!==this:this.outdated)?this.impl._format(e,t):super._format(e,t)}_declare(e,t,s){s.has(this)||(s.add(this),this.impl._declare(e,t,s),t[this.name]===this&&e.push(this.name+"="+this.impl.format({terse:!0,inventory:t})))}};k("I",n=>n);k("K",n=>e=>n);k("S",n=>e=>t=>n.apply(t,e.apply(t)));k("B",n=>e=>t=>n.apply(e.apply(t)));k("C",n=>e=>t=>n.apply(t).apply(e));k("W",n=>e=>n.apply(e).apply(e));k("+",n=>n instanceof F?new F(n.n+1):e=>t=>e.apply(n.apply(e,t)),{note:"Increase a Church numeral argument by 1, otherwise n => f => x => f(n f x)"});function fe(n){let e=Object.keys(n).filter(i=>!(n[i]instanceof _&&n[i].name===i)).map(i=>i+" = "+n[i]);if(e.length>0)throw new Error("Inventory must be a hash of named terms with matching names: "+e.join(", "));n={...n};let t=[],s=1;for(let i in m){if(!(n[i]instanceof x))continue;for(;"temp"+s in n;)s++;let h="temp"+s,c=n[i];delete n[i];let o=new x(h,c);for(let u in n)n[u]=n[u].subst(c,o)??n[u];n[h]=o,t.push([i,h])}let r=Object.values(n).filter(i=>i instanceof x).sort((i,h)=>i.name.localeCompare(h.name)),a=[],l=new Set;for(let i of r)i._declare(a,n,l);for(let[i,h]of t)a.push(i+"="+h),a.push(h+"=");return a}function B(n,e,t={}){let s=new Array(n.length).fill(0),r=!0;e.traverse(i=>{if(i instanceof w){let h=n.findIndex(c=>c.name===i.name);if(h>=0){s[h]++;return}}i instanceof d||(r=!1)});let a=new Set,l=new Set;for(let i=0;i<n.length;i++)s[i]===0?a.add(i):s[i]>1&&l.add(i);return{expr:n.length?new b(n,e):e,...t.synth?{}:{arity:n.length},...a.size?{skip:a}:{},...l.size?{dup:l}:{},duplicate:!!l.size||t.duplicate||!1,discard:!!a.size||t.discard||!1,proper:r}}function j(n){if(n instanceof d)return j(n.fun).apply(j(n.arg));if(n instanceof b)return new b(n.arg,j(n.impl));if(n instanceof x)return j(n.impl);let e=n.guess();if(e.expr)return e.expr;throw new Error("Failed to canonize expression: "+n)}function J(n){return new w("abcdefgh"[n]??"x"+n)}function*V(n,e={},t={steps:0}){if(yield{expr:n,steps:t.steps,comment:"(self)"},n.freeOnly())return;let s=n.weight();if(n instanceof b)for(let a of V(n.impl,e,t)){let l=new b(n.arg,a.expr);l.weight()<s&&(s=l.weight(),yield{expr:l,steps:t.steps,comment:"(lambda)"+a.comment})}if(n instanceof d){let[a,l]=n.split();for(let i of V(a,e,t)){let h=i.expr.apply(l);h.weight()<s&&(s=h.weight(),a=i.expr,yield{expr:h,steps:t.steps,comment:"(fun)"+i.comment})}for(let i of V(l,e,t)){let h=a.apply(i.expr);h.weight()<s&&(s=h.weight(),yield{expr:h,steps:t.steps,comment:"(arg)"+i.comment})}}let r=n.guess({max:e.max,maxArgs:e.maxArgs});t.steps+=r.steps,r.expr&&r.expr.weight()<s&&(yield{expr:r.expr,steps:t.steps,comment:"(canonical)"})}f.declare=fe;f.native=m;G.exports={Expr:f,App:d,FreeVar:w,Lambda:b,Native:S,Alias:x,Church:F}});var $=z((Ee,se)=>{"use strict";var{Tokenizer:pe,restrict:C}=Q(),Y=H(),{Expr:P,Native:me,Alias:v,FreeVar:q,Lambda:de,Church:ee}=Y,{native:L,declare:te}=P,E=class extends P{apply(...e){return e.length?e.shift().apply(...e):this}postParse(){throw new Error("Attempt to use empty expression () as a term")}},K=class n extends E{constructor(e,t={}){if(super(),this.impl=new E,e instanceof q)this.terms=[e];else if(e instanceof n){if(!(e.impl instanceof q))throw new Error("Expected FreeVar->...->FreeVar->Expr");this.terms=[...e.terms,e.impl]}else throw new Error("Expected FreeVar or PartialLambda")}apply(e,...t){if(e===null||t.length!==0)throw new Error("bad syntax in partial lambda expr");return this.impl=this.impl.apply(e),this}postParse(){return new de(this.terms,this.impl)}};function X(n){return n.postParse?n.postParse():n}var we=new pe("[()]","[A-Z]","[a-z_][a-z_0-9]*","\\b[0-9]+\\b","->","\\+"),g=class n{constructor(e={}){if(this.annotate=e.annotate??!1,this.known={...L},this.hasNumbers=!0,this.hasLambdas=!0,this.allow=new Set(Object.keys(this.known)),Array.isArray(e.terms))this.bulkAdd(e.terms);else if(e.terms)for(let t in e.terms)e.terms[t].match(/^Native:/)||this.add(t,e.terms[t]);this.hasNumbers=e.numbers??!0,this.hasLambdas=e.lambdas??!0,e.allow&&this.restrict(e.allow)}add(e,t,s){if(e=this._named(e,t),this.annotate&&s===void 0){let r=e.guess();r.expr&&(s=r.expr.format({terse:!0,html:!0,lambda:[""," &mapsto; ",""]}))}return s!==void 0&&(e.note=s),this.known[e.name]&&(this.known[e.name].outdated=!0),this.known[e.name]=e,this.allow.add(e.name),this}_named(e,t){if(e instanceof v)return new v(e.name,e.impl,{canonize:!0});if(typeof e!="string")throw new Error("add(): term must be an Alias or a string");if(t===void 0)throw new Error("add(): impl must be provided when term is a string");if(typeof t=="string")return new v(e,this.parse(t),{canonize:!0});if(t instanceof P)return new v(e,t,{canonize:!0});if(typeof t=="function")return new me(e,t);throw new Error("add(): impl must be an Expr, a string, or a function with a signature Expr => ... => Expr")}maybeAdd(e,t){return this.known[e]?this.allow.add(e):this.add(e,t),this}bulkAdd(e){for(let t of e){let s=t.match(/^([A-Z]|[a-z][a-z_0-9]*)\s*=\s*(.*)$/s);if(!s)throw new Error("bulkAdd: invalid declaration: "+t);s[2]===""?this.remove(s[1]):this.add(s[1],this.parse(s[2]))}return this}restrict(e){return this.allow=C(this.allow,e),this}showRestrict(e="+"){let t=[],s=!0;for(let r of[...C(this.allow,e)].sort()){let a=r.match(/^[A-Z]$/);t.length&&!(s&&a)&&t.push(" "),t.push(r),s=a}return t.join("")}remove(e){return this.known[e].outdated=!0,delete this.known[e],this.allow.delete(e),this}getTerms(){let e={};for(let t of Object.keys(this.known))this.allow.has(t)&&(e[t]=this.known[t]);return e}declare(){return te(this.getTerms())}parse(e,t={}){if(typeof e!="string")throw new Error("parse: source must be a string, got "+typeof e);let s=e.replace(/\/\/[^\n]*$/gm,"").split(/\s*;[\s;]*/).filter(l=>l.match(/\S/)),r={...t.env},a=new E;for(let l of s){let[i,h,c]=l.match(/^(?:\s*([A-Z]|[a-z][a-z_0-9]*)\s*=\s*)?(.*)$/s);if(a instanceof v&&(a.outdated=!0),a=this.parseLine(c,r,t),h!==void 0){if(r[h]!==void 0)throw new Error("Attempt to redefine a known term: "+h);a=new v(h,a),r[h]=a}}return a}parseLine(e,t={},s={}){let r={numbers:s.numbers??this.hasNumbers,lambdas:s.lambdas??this.hasLambdas,allow:C(this.allow,s.allow)};r.numbers?r.allow.add("+"):r.allow.delete("+");let a=we.split(e),l=new E,i=[l],h=s.scope||n;for(let c of a)if(c==="(")i.push(l);else if(c===")"){if(i.length<2)throw new Error("unbalanced input: extra closing parenthesis"+e);let o=X(i.pop()),u=i.pop();i.push(u.apply(o))}else if(c==="->"){if(!r.lambdas)throw new Error("Lambdas not supported, allow them explicitly");i.push(new K(i.pop(),t))}else if(c.match(/^[0-9]+$/)){if(!r.numbers)throw new Error("Church numbers not supported, allow them explicitly");let o=i.pop();i.push(o.apply(new ee(c)))}else{let o=i.pop();if(!t[c]&&this.known[c]&&!r.allow.has(c))throw new Error("Term '"+c+"' is not in the restricted set "+[...r.allow].sort().join(" "));let u=t[c]??this.known[c]??(t[c]=new q(c,h));i.push(o.apply(u))}if(i.length!==1)throw new Error("unbalanced input: missing "+(i.length-1)+" closing parenthesis:"+e);return X(i.pop())}toJSON(){return{version:"1.1.1",allow:this.showRestrict("+"),numbers:this.hasNumbers,lambdas:this.hasLambdas,annotate:this.annotate,terms:this.declare()}}};g.classes=Y;g.vars=function(n={}){let e={};return new Proxy({},{get:(t,s)=>(s in e||(e[s]=new q(s,n)),e[s])})};g.church=n=>new ee(n);for(let n in L)g[n]=L[n];g.native=L;g.declare=te;se.exports={SKI:g}});var ae=z((je,ne)=>{var{SKI:A}=$(),{Expr:Ae,FreeVar:ge,Alias:re,Lambda:ze}=A.classes,Z=class{constructor(e={}){let{input:t,vars:s,cases:r,allow:a,numbers:l,lambdas:i,subst:h,engine:c,engineFull:o,...u}=e;this.engine=c??new A,this.engineFull=o??new A,this.restrict={allow:a,numbers:l??!1,lambdas:i??!1},this.vars={},this.subst=Array.isArray(h)?h:[h??"phi"];let U={};for(let p of s??[]){let y=this.engineFull.parse(p,{env:U,scope:this});if(y instanceof A.classes.Alias)this.vars[y.name]=new re(y.name,y.impl,{terminal:!0,canonize:!1});else if(y instanceof A.classes.FreeVar)this.vars[y.name]=y;else throw new Error("Unsupported given variable type: "+p)}this.input=[];for(let p of Array.isArray(t)?t:[t])this.addInput(p);if(!this.input.length)throw new Error("Quest needs at least one input placeholder");h&&(this.input[0].fancy=this.subst[0]),this.varsFull={...this.vars,...U};for(let p of this.input){if(p.name in this.varsFull)throw new Error("input placeholder name is duplicated or clashes with vars: "+p.name);this.varsFull[p.name]=p.placeholder}this.cases=[],this.title=u.title,u.descr=be(u.descr),this.descr=u.descr,this.meta=u;for(let p of r??[])this.add(...p)}allowed(){let e=this.restrict.allow??"",t=Object.keys(this.vars).sort();return e?this.engine.showRestrict(e+"+"+t.join(" ")):t.map(s=>"+"+s).join(" ")}addInput(e){if(typeof e!="object"&&(e={name:e}),typeof e.name!="string")throw new Error("quest 'input' field must be a string or a {name: string, ...} object");e.placeholder=new A.classes.FreeVar(e.name),this.input.push(e)}add(e,...t){typeof e=="string"?(t.unshift(e),e={}):e={...e},e.engine=e.engine??this.engineFull,e.vars=e.vars??this.varsFull;let s=this.input.map(r=>r.placeholder);return this.cases.push(e.caps?new T(s,e,t):new R(s,e,t)),this}prepare(...e){if(e.length!==this.input.length)throw new Error("Solutions provided "+e.length+" terms where "+this.input.length+" are expected");let t=0,s=[],r={...this.vars};for(let a=0;a<e.length;a++){let l=this.input[a],i=this.engine.parse(e[a],{env:r,allow:l.allow??this.restrict.allow,numbers:l.numbers??this.restrict.numbers,lambdas:l.lambdas??this.restrict.lambdas});t+=i.weight();let h=i instanceof ge?i:new re(l.fancy??l.name,i,{terminal:!0,canonize:!1});r[l.name]=h,s.push(h)}return{prepared:s,weight:t}}check(...e){try{let{prepared:t,weight:s}=this.prepare(...e),r=this.cases.map(i=>i.check(...t)),a=r.reduce((i,h)=>i&&h.pass,!0),l=r.reduce((i,h)=>i+h.steps,0);return{expr:t[0],input:t,pass:a,steps:l,details:r,weight:s}}catch(t){return{pass:!1,details:[],exception:t,steps:0,input:e}}}show(){return[...this.cases]}},O=class{constructor(e,t){this.max=t.max??1e3,this.note=t.note,this.vars={...t.vars??{}},this.input=e,this.engine=t.engine}parse(e){return new D(this.engine.parse(e,{env:this.vars,scope:this}),this.input)}check(...e){throw new Error("not implemented")}},R=class extends O{constructor(e,t,s){if(s.length!==2)throw new Error("Case accepts exactly 2 strings");super(e,t),[this.e1,this.e2]=s.map(r=>this.parse(r))}check(...e){let t=this.e1.apply(e),s=t.run({max:this.max}),a=this.e2.apply(e).run({max:this.max}),l=null;return!s.final||!a.final?l="failed to reach normal form in "+this.max+" steps":l=s.expr.diff(a.expr),{pass:!l,reason:l,steps:s.steps,start:t,found:s.expr,expected:a.expr,note:this.note,args:e,case:this}}},xe={normal:!0,proper:!0,discard:!0,duplicate:!0,linear:!0,affine:!0,arity:!0},T=class extends O{constructor(e,t,s){if(super(e,t),s.length>1)throw new Error("PropertyCase accepts exactly 1 string");if(!t.caps||typeof t.caps!="object"||!Object.keys(t.caps).length)throw new Error("PropertyCase requires a caps object with at least one capability");let r=Object.keys(t.caps).filter(a=>!xe[a]);if(r.length)throw new Error("PropertyCase: don't know how to test these capabilities: "+r.join(", "));this.expr=this.parse(s[0]),this.caps=t.caps,this.caps.linear&&(delete this.caps.linear,this.caps.duplicate=!1,this.caps.discard=!1,this.caps.normal=!0),this.caps.affine&&(delete this.caps.affine,this.caps.normal=!0,this.caps.duplicate=!1)}check(...e){let t=this.expr.apply(e),s=t.run({max:this.max}),r=s.expr.guess({max:this.max}),a=[];for(let l in this.caps)r[l]!==this.caps[l]&&a.push("expected property "+l+" to be "+this.caps[l]+", found "+r[l]);return{pass:!a.length,reason:a?a.join(`
`):null,steps:s.steps,start:t,found:s.expr,case:this,note:this.note,args:e}}},D=class{constructor(e,t){this.expr=e,this.vars=t}apply(e){if(e.length!==this.vars.length)throw new Error("Subst: expected "+this.vars.length+" terms, got "+e.length);let t=this.expr;for(let s=0;s<this.vars.length;s++)t=t.subst(this.vars[s],e[s])??t;return t}};function be(n){return n===void 0?n:Array.isArray(n)?n.join(" "):""+n}ne.exports={Quest:Z}});var ye=z((Se,he)=>{var ie=$(),le=ae();he.exports={...ie,...le};typeof window<"u"&&(window.SKI=ie.SKI,window.SKI.Quest=le.Quest)});ye();})();
//# sourceMappingURL=ski-interpreter.min.js.map
