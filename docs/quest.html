<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8"/>
    <title>Quests - Simple Kombinator Interpreter</title>
    <link rel="shortcut icon" type="image/png" href="img/ski-64.png">
    <script src="build/js/ski-interpreter.min.js"></script>
    <script src="build/js/util.min.js"></script>
    <script src="js/quest.js"></script>
    <link rel="stylesheet" href="css/main.css">
    <link rel="stylesheet" href="css/quest.css">
    <style>
        body {
            height: 100vh;
            padding: 0;
            margin: 0;
            display: grid;
            grid-template-columns: 15fr 70fr 15fr;
            grid-template-rows: auto 1fr auto;
            grid-template-areas:
               "header header header"
               "chapters main inventory"
               "footer footer footer";
        }
    </style>
    <script>
        // TODO: move elsewhere
        function showTerm(term) {
            return term.note ?? (term.impl ?? term).format({html: true, lambda: ['', ' &mapsto; ', '']});
        }
    </script>
</head>
<body>
    <header id="top" class="layout" style="grid-area: header;">
        <div class="float-left"><span id="menu" class="big">&#9776;</span></div>
        <h1><img src="img/mock1.png">Simple Kombinator Interpreter Quests<img src="img/mock2.png"></h1>
    </header>
    <div class="side pane" style="grid-area: chapters;">
        <div class="content-table" id="chapterlist"></div>
    </div>
    <div class="pane" id="quest" style="grid-area: main;"></div>
    <div class="side pane" style="grid-area: inventory;">
        <div class="quest-inventory quest-box">
            <h3>Inventory</h3>
            <dl id="known" class="term-list">
            </dl>
        </div>
    </div>
    <footer class="layout" id="bottom" style="grid-area: footer; text-align: center; font-size: smaller;">
        <div>
            &copy;&thinsp;2024&thinsp;&ndash;&thinsp;2026
            <a href="https://github.com/dallaylaen" target="_blank">dallaylaen</a>
            (<a href="https://github.com/dallaylaen/ski-interpreter" target="_blank">sources</a>)
        </div>
    </footer>
<script>
    const { Expr } = SKI.classes; // just for type annotations

    const store = new Store('quest-page');
    const skiopt = store.load('engine') ?? {lambdas: false, numbers: false, allow: 'SKI'};
    skiopt.annotate = true;
    const ski = new SKI(skiopt);

    const chapters = [];

    const view = util.grabView('quest', 'known', 'chapterlist', 'menu');
    const questDir = 'quest-data/';

    const linkedTo = window.location.hash.slice(1);

    showKnown();
    initMenu();
    loadQuests();

    function loadQuests() {
        fetch(questDir + 'index.json')
            .then( resp => resp.json())
            .then( list => {
                const joint = [];
                for (const item of list) {
                    const chapter = new Chapter({ link: questDir + item, engine: ski, store });
                    chapters.push(chapter);
                    chapter.attach(view.quest, {placeholder: 'loading chapter' + chapter.number + '...'});
                    chapter.addLink(view.chapterlist);
                    joint.push(chapter.fetch().then(chapter => {
                        chapter.draw();
                    }));
                }
                Promise.all(joint).then( () => {
                    if (linkedTo) {
                        const target = document.getElementById(linkedTo);
                        if (target)
                            target.scrollIntoView();
                    }
                });
            });
    }

    function initMenu() {
        const menu = new Hamburger(view.menu);
        menu.addLink('playground', 'index.html', '_blank');
        menu.addLink('introduction', 'intro.html', '_blank');
        menu.addLink('combinatory logic', 'https://en.wikipedia.org/wiki/Combinatory_logic', '_blank');
        menu.addAction('<span class="danger">&cross; erase progress</span>', () => {
            if (confirm('Are you sure you want to start over?'))
                demolish();
        });
    }

    function showKnown() {
        view.known.innerHTML = '';
        const terms = ski.getTerms();
        for (const entry of Object.keys(terms).sort().map(x => [x, terms[x]]))
            append(view.known, 'div', {content: `<dt>${entry[0]}</dt><dd>= ${showTerm(entry[1])}</dd>`});
    }

    function demolish() {
        for (const key of store.scan()) {
            store.delete(key);
        };
        window.location.reload();
    }

</script>
</body>
</html>
